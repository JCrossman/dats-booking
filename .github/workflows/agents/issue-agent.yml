name: Agent - Issue Triggered

# Example workflow that triggers agents on issue events
# This is a template - customize based on your needs

on:
  issues:
    types: [opened, labeled]

jobs:
  detect-trigger:
    name: Detect Agent Trigger
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      agent_name: ${{ steps.check.outputs.agent_name }}
    
    steps:
      - name: Check issue labels for agent triggers
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name);
            
            // Map labels to agents
            const labelToAgent = {
              'needs-pm-review': 'product-manager',
              'needs-architecture': 'architect',
              'needs-security-review': 'security-privacy',
              'needs-accessibility-review': 'accessibility-specialist',
              'needs-qa-review': 'qa-tester'
            };
            
            // Check if any trigger label is present
            for (const [label, agent] of Object.entries(labelToAgent)) {
              if (labels.includes(label)) {
                core.setOutput('should_run', 'true');
                core.setOutput('agent_name', agent);
                console.log(`Trigger detected: ${label} -> ${agent}`);
                return;
              }
            }
            
            core.setOutput('should_run', 'false');
            console.log('No agent trigger labels found');
  
  run-agent:
    name: Run ${{ needs.detect-trigger.outputs.agent_name }} Agent
    needs: detect-trigger
    if: needs.detect-trigger.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup environment
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq
      
      - name: Run agent (dry-run)
        env:
          AGENT_NAME: ${{ needs.detect-trigger.outputs.agent_name }}
          DRY_RUN: true
          GITHUB_ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          echo "ðŸ¤– Running agent for issue #${{ github.event.issue.number }}"
          echo "   Title: ${{ github.event.issue.title }}"
          echo ""
          
          .github/agents/run-agent.sh
      
      - name: Post comment
        uses: actions/github-script@v7
        with:
          script: |
            const agentName = '${{ needs.detect-trigger.outputs.agent_name }}';
            
            await github.rest.issues.createComment({
              ...context.repo,
              issue_number: context.payload.issue.number,
              body: `ðŸ¤– **${agentName}** agent triggered (dry-run mode)\n\n` +
                    `The agent has analyzed this issue. In live mode, it would provide detailed feedback.\n\n` +
                    `_This is a demonstration. Enable live mode in the workflow to get actual agent reviews._`
            });
