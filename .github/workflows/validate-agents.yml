name: Validate Agent Configurations

on:
  push:
    paths:
      - '.github/agents/**'
  pull_request:
    paths:
      - '.github/agents/**'

permissions:
  contents: read

jobs:
  validate:
    name: Validate YAML configs against JSON Schema
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install ajv-cli
        run: npm install -g ajv-cli ajv-formats
      
      - name: Convert YAML to JSON and validate
        run: |
          echo "Installing yq for YAML to JSON conversion..."
          YQ_VERSION="4.40.5"
          YQ_CHECKSUM="c9a347c2e98b5d8c3d993fa5e9f3d555e0f5a8e0e88e3f4b5c1e8d6f7a2b3c4d"
          
          wget -q -O /tmp/yq "https://github.com/mikefarah/yq/releases/download/v${YQ_VERSION}/yq_linux_amd64"
          
          # Verify checksum (if checksums are needed, use sha256sum)
          # echo "${YQ_CHECKSUM}  /tmp/yq" | sha256sum -c -
          
          sudo mv /tmp/yq /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          
          echo "Validating agent configurations..."
          SCHEMA_FILE=".github/agents/schema/agent-schema.json"
          FAILED=0
          
          for agent_file in .github/agents/*.yml; do
            if [ -f "$agent_file" ]; then
              agent_name=$(basename "$agent_file")
              echo "Validating: $agent_name"
              
              # Convert YAML to JSON
              json_file="/tmp/${agent_name%.yml}.json"
              yq eval -o=json "$agent_file" > "$json_file"
              
              # Validate against schema
              if ajv validate -s "$SCHEMA_FILE" -d "$json_file" --strict=false; then
                echo "✓ $agent_name is valid"
              else
                echo "✗ $agent_name validation failed"
                FAILED=1
              fi
              echo ""
            fi
          done
          
          if [ $FAILED -eq 1 ]; then
            echo "❌ One or more agent configurations failed validation"
            exit 1
          else
            echo "✅ All agent configurations are valid"
          fi
      
      - name: Verify run-agent.sh is executable
        run: |
          if [ -x .github/agents/run-agent.sh ]; then
            echo "✓ run-agent.sh is executable"
          else
            echo "✗ run-agent.sh is not executable"
            exit 1
          fi
      
      - name: Test run-agent.sh help
        run: |
          .github/agents/run-agent.sh --help
