<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DATS API Tester</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1e1e1e;
      color: #d4d4d4;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    h1 {
      color: #569cd6;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #858585;
      margin-bottom: 30px;
    }

    .panel {
      background: #252526;
      border: 1px solid #3e3e42;
      border-radius: 6px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .panel h2 {
      color: #4ec9b0;
      font-size: 18px;
      margin-bottom: 15px;
      border-bottom: 1px solid #3e3e42;
      padding-bottom: 10px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      color: #9cdcfe;
      margin-bottom: 5px;
      font-weight: 500;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      background: #3c3c3c;
      border: 1px solid #3e3e42;
      border-radius: 4px;
      color: #d4d4d4;
      font-size: 14px;
      font-family: 'Consolas', 'Monaco', monospace;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #569cd6;
    }

    button {
      background: #0e639c;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: background 0.2s;
    }

    button:hover {
      background: #1177bb;
    }

    button:disabled {
      background: #3e3e42;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: #3e3e42;
      margin-left: 10px;
    }

    .btn-secondary:hover {
      background: #505050;
    }

    .response-section {
      margin-top: 20px;
    }

    .response-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-success {
      background: #0e7c0e;
      color: white;
    }

    .status-error {
      background: #f44747;
      color: white;
    }

    pre {
      background: #1e1e1e;
      border: 1px solid #3e3e42;
      border-radius: 4px;
      padding: 15px;
      overflow-x: auto;
      font-size: 13px;
      font-family: 'Consolas', 'Monaco', monospace;
      color: #ce9178;
      line-height: 1.5;
    }

    .xml-tag {
      color: #569cd6;
    }

    .xml-attr {
      color: #9cdcfe;
    }

    .xml-value {
      color: #ce9178;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #3e3e42;
      border-top-color: #569cd6;
      border-radius: 50%;
      animation: spin 0.6s linear infinite;
      margin-left: 10px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .helper-text {
      font-size: 12px;
      color: #858585;
      margin-top: 5px;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    @media (max-width: 768px) {
      .grid {
        grid-template-columns: 1fr;
      }
    }

    .session-status {
      padding: 10px;
      background: #3c3c3c;
      border-radius: 4px;
      margin-top: 10px;
      font-size: 13px;
    }

    .session-active {
      border-left: 3px solid #0e7c0e;
    }

    .session-inactive {
      border-left: 3px solid #858585;
    }

    .copy-btn {
      padding: 6px 12px;
      font-size: 12px;
      background: #3e3e42;
    }

    .copy-btn:hover {
      background: #505050;
    }

    .interpretation {
      background: #2d2d30;
      border-left: 3px solid #569cd6;
      padding: 15px;
      margin-top: 15px;
      border-radius: 4px;
    }

    .interpretation h3 {
      color: #569cd6;
      font-size: 14px;
      margin-bottom: 10px;
    }

    .interpretation ul {
      margin-left: 20px;
      color: #d4d4d4;
    }

    .interpretation li {
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß DATS API Tester</h1>
    <p class="subtitle">Test DATS SOAP API operations and see raw responses</p>

    <!-- Authentication Panel -->
    <div class="panel">
      <h2>1. Authentication</h2>

      <div class="grid">
        <div class="form-group">
          <label for="clientId">Client ID</label>
          <input type="text" id="clientId" placeholder="46642" value="46642">
        </div>

        <div class="form-group">
          <label for="passcode">Passcode</label>
          <input type="password" id="passcode" placeholder="Your passcode">
        </div>
      </div>

      <button id="loginBtn" onclick="login()">Login to DATS</button>

      <div id="sessionStatus" class="session-status session-inactive" style="display: none;">
        <strong>Session:</strong> <span id="sessionText">Not logged in</span>
      </div>
    </div>

    <!-- API Operation Panel -->
    <div class="panel">
      <h2>2. Select API Operation</h2>

      <div class="form-group">
        <label for="operation">Operation</label>
        <select id="operation" onchange="updateOperationParams()">
          <option value="PassGetClientTrips">PassGetClientTrips - Get trip list</option>
          <option value="PassGetClientInfo">PassGetClientInfo - Get client profile</option>
          <option value="PassGetClientLocationsMerged">PassGetClientLocationsMerged - Get saved locations</option>
          <option value="PassGetMostFrequentClientTrips">PassGetMostFrequentClientTrips - Get frequent trips</option>
          <option value="PassBookingDaysWindow">PassBookingDaysWindow - Get available booking days</option>
          <option value="PassGetDefaultBooking">PassGetDefaultBooking - Get booking options</option>
          <option value="PassPullForImminentArrivals">PassPullForImminentArrivals - Real-time tracking</option>
        </select>
        <div class="helper-text" id="operationHelp"></div>
      </div>

      <div id="operationParams"></div>

      <button id="sendBtn" onclick="sendRequest()" disabled>Send Request</button>
      <button class="btn-secondary" onclick="clearResponse()">Clear Response</button>
    </div>

    <!-- Response Panel -->
    <div class="panel" id="responsePanel" style="display: none;">
      <div class="response-header">
        <h2>3. Response</h2>
        <div>
          <span id="statusBadge" class="status-badge"></span>
          <button class="copy-btn" onclick="copyResponse()">Copy XML</button>
        </div>
      </div>

      <pre id="responseXml"></pre>

      <div id="interpretation" class="interpretation" style="display: none;"></div>
    </div>
  </div>

  <script>
    let sessionCookie = null;
    let currentClientId = null;

    const operationTemplates = {
      PassGetClientTrips: {
        help: 'Get list of trips with date range and optional status filter',
        params: [
          { name: 'FromDate', type: 'date', label: 'From Date', default: '20260115' },
          { name: 'ToDate', type: 'date', label: 'To Date', default: '20260115' },
          { name: 'Status', type: 'text', label: 'Status Filter (optional)', default: 'S,Pf,CA', placeholder: 'e.g., S,Pf,CA or leave empty' }
        ],
        buildXml: (params) => `<PassGetClientTrips>
      <OutputVersion>2</OutputVersion>
      <ClientId>${currentClientId}</ClientId>
      <FromDate>${params.FromDate}</FromDate>
      <ToDate>${params.ToDate}</ToDate>
      ${params.Status ? `<Status>${params.Status}</Status>` : ''}
    </PassGetClientTrips>`,
        interpret: interpretTrips
      },
      PassGetClientInfo: {
        help: 'Get comprehensive client profile information',
        params: [],
        buildXml: () => `<PassGetClientInfo>
      <ClientId>${currentClientId}</ClientId>
    </PassGetClientInfo>`,
        interpret: interpretProfile
      },
      PassGetClientLocationsMerged: {
        help: 'Get merged list of registered + frequent locations',
        params: [],
        buildXml: () => `<PassGetClientLocationsMerged>
      <ClientId>${currentClientId}</ClientId>
    </PassGetClientLocationsMerged>`,
        interpret: interpretLocations
      },
      PassGetMostFrequentClientTrips: {
        help: 'Get frequently used trip pairs',
        params: [
          { name: 'FromDate', type: 'date', label: 'Analyze from Date', default: '20251116' }
        ],
        buildXml: (params) => `<PassGetMostFrequentClientTrips>
      <OutputVersion>2</OutputVersion>
      <FromDate>${params.FromDate}</FromDate>
      <ClientId>${currentClientId}</ClientId>
    </PassGetMostFrequentClientTrips>`,
        interpret: interpretFrequentTrips
      },
      PassBookingDaysWindow: {
        help: 'Get available booking days (3-day advance window)',
        params: [],
        buildXml: () => `<PassBookingDaysWindow>
      <RequestedTimeType>pickup</RequestedTimeType>
      <CalendarDay>1</CalendarDay>
    </PassBookingDaysWindow>`,
        interpret: null
      },
      PassGetDefaultBooking: {
        help: 'Get booking defaults and available options',
        params: [
          { name: 'Date', type: 'date', label: 'Date', default: '20260115' }
        ],
        buildXml: (params) => `<PassGetDefaultBooking>
      <Date>${params.Date}</Date>
      <ClientId>${currentClientId}</ClientId>
    </PassGetDefaultBooking>`,
        interpret: null
      },
      PassPullForImminentArrivals: {
        help: 'Real-time tracking (only works within 60 min of pickup)',
        params: [
          { name: 'duration', type: 'number', label: 'Duration (minutes)', default: '60' }
        ],
        buildXml: (params) => `<PassPullForImminentArrivals>
      <duration>${params.duration}</duration>
      <ClientId>${currentClientId}</ClientId>
    </PassPullForImminentArrivals>`,
        endpoint: 'PassInfoServerAsync',
        interpret: null
      }
    };

    function updateOperationParams() {
      const operation = document.getElementById('operation').value;
      const template = operationTemplates[operation];

      document.getElementById('operationHelp').textContent = template.help;

      const paramsDiv = document.getElementById('operationParams');
      paramsDiv.innerHTML = '';

      if (template.params.length > 0) {
        template.params.forEach(param => {
          const formGroup = document.createElement('div');
          formGroup.className = 'form-group';

          const label = document.createElement('label');
          label.textContent = param.label;
          label.htmlFor = `param_${param.name}`;

          const input = document.createElement('input');
          input.type = param.type;
          input.id = `param_${param.name}`;
          input.name = param.name;
          input.value = param.default || '';
          input.placeholder = param.placeholder || '';

          formGroup.appendChild(label);
          formGroup.appendChild(input);
          paramsDiv.appendChild(formGroup);
        });
      }
    }

    async function login() {
      const clientId = document.getElementById('clientId').value;
      const passcode = document.getElementById('passcode').value;

      if (!clientId || !passcode) {
        alert('Please enter both Client ID and Passcode');
        return;
      }

      const loginBtn = document.getElementById('loginBtn');
      loginBtn.disabled = true;
      loginBtn.innerHTML = 'Logging in... <span class="loading"></span>';

      const xml = buildSoapEnvelope(`<PassValidatePassword>
      <ClientCode>${clientId}</ClientCode>
      <Password>${passcode}</Password>
    </PassValidatePassword>`);

      try {
        const response = await fetch('/proxy/PassInfoServer', {
          method: 'POST',
          headers: {
            'Content-Type': 'text/xml; charset=utf-8'
          },
          body: xml,
          credentials: 'include'
        });

        const responseText = await response.text();

        // Check for errors in response
        if (responseText.includes('error') || responseText.includes('Error')) {
          throw new Error('Login failed - check your credentials');
        }

        // Extract session cookie from response headers
        // Note: Due to CORS, we might not be able to read Set-Cookie headers
        // The browser will handle cookies automatically
        sessionCookie = 'auto'; // Browser manages it
        currentClientId = clientId;

        document.getElementById('sessionStatus').style.display = 'block';
        document.getElementById('sessionStatus').className = 'session-status session-active';
        document.getElementById('sessionText').textContent = `Logged in as Client ${clientId}`;
        document.getElementById('sendBtn').disabled = false;

        loginBtn.innerHTML = 'Login Successful ‚úì';
        setTimeout(() => {
          loginBtn.innerHTML = 'Login to DATS';
          loginBtn.disabled = false;
        }, 2000);

        updateOperationParams();

      } catch (error) {
        alert('Login failed: ' + error.message);
        loginBtn.innerHTML = 'Login to DATS';
        loginBtn.disabled = false;
      }
    }

    async function sendRequest() {
      const operation = document.getElementById('operation').value;
      const template = operationTemplates[operation];

      // Collect parameters
      const params = {};
      template.params.forEach(param => {
        const input = document.getElementById(`param_${param.name}`);
        if (input && input.value) {
          params[param.name] = input.value;
        }
      });

      const operationXml = template.buildXml(params);
      const xml = buildSoapEnvelope(operationXml);

      const sendBtn = document.getElementById('sendBtn');
      sendBtn.disabled = true;
      sendBtn.innerHTML = 'Sending... <span class="loading"></span>';

      const endpoint = template.endpoint || 'PassInfoServer';

      try {
        const response = await fetch(`/proxy/${endpoint}`, {
          method: 'POST',
          headers: {
            'Content-Type': 'text/xml; charset=utf-8'
          },
          body: xml,
          credentials: 'include'
        });

        const responseText = await response.text();

        displayResponse(response.status, responseText, template.interpret);

        sendBtn.innerHTML = 'Send Request';
        sendBtn.disabled = false;

      } catch (error) {
        alert('Request failed: ' + error.message);
        sendBtn.innerHTML = 'Send Request';
        sendBtn.disabled = false;
      }
    }

    function buildSoapEnvelope(body) {
      return `<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/">
  <SOAP-ENV:Body>
    ${body}
  </SOAP-ENV:Body>
</SOAP-ENV:Envelope>`;
    }

    function displayResponse(status, xml, interpretFn) {
      const panel = document.getElementById('responsePanel');
      const badge = document.getElementById('statusBadge');
      const xmlPre = document.getElementById('responseXml');
      const interpretDiv = document.getElementById('interpretation');

      panel.style.display = 'block';

      badge.textContent = `HTTP ${status}`;
      badge.className = status === 200 ? 'status-badge status-success' : 'status-badge status-error';

      // Format XML with syntax highlighting
      xmlPre.innerHTML = formatXml(xml);

      // Show interpretation if available
      if (interpretFn) {
        const interpretation = interpretFn(xml);
        if (interpretation) {
          interpretDiv.innerHTML = interpretation;
          interpretDiv.style.display = 'block';
        } else {
          interpretDiv.style.display = 'none';
        }
      } else {
        interpretDiv.style.display = 'none';
      }

      panel.scrollIntoView({ behavior: 'smooth' });
    }

    function formatXml(xml) {
      // Simple XML formatting with syntax highlighting
      let formatted = xml.replace(/</g, '&lt;').replace(/>/g, '&gt;');
      formatted = formatted.replace(/&lt;(\/?[\w-]+)/g, '<span class="xml-tag">&lt;$1</span>');
      formatted = formatted.replace(/([\w-]+)=/g, '<span class="xml-attr">$1</span>=');
      return formatted;
    }

    function interpretTrips(xml) {
      const trips = [];
      const tripRegex = /<Trip>([\s\S]*?)<\/Trip>/g;
      let match;

      while ((match = tripRegex.exec(xml)) !== null) {
        const tripXml = match[1];
        const trip = {
          confirmation: extractTag(tripXml, 'ConfirmationNumber'),
          status: extractTag(tripXml, 'StatusCode'),
          statusLabel: extractTag(tripXml, 'StatusLabel'),
          date: extractTag(tripXml, 'BookingDate')
        };
        trips.push(trip);
      }

      if (trips.length === 0) return null;

      let html = '<h3>üìä Trip Status Analysis</h3><ul>';
      trips.forEach((trip, i) => {
        html += `<li><strong>Trip #${i+1}:</strong> Confirmation ${trip.confirmation} - `;
        html += `Status: <strong>${trip.statusLabel} (${trip.status})</strong>`;

        if (trip.status === 'S') {
          html += ' ‚Üí DATS says "Scheduled" (not marked as Performed yet)';
        } else if (trip.status === 'Pf') {
          html += ' ‚Üí DATS says "Performed" (trip completed)';
        } else if (trip.status === 'CA') {
          html += ' ‚Üí DATS says "Cancelled"';
        }
        html += '</li>';
      });
      html += '</ul>';

      if (trips.some(t => t.status === 'S')) {
        html += '<p style="margin-top: 10px; color: #ce9178;">‚ö†Ô∏è Trips showing "Scheduled" indicate DATS hasn\'t updated the status yet. This is normal - status updates may be batch-processed.</p>';
      }

      return html;
    }

    function interpretProfile(xml) {
      const firstName = extractTag(xml, 'FirstName');
      const lastName = extractTag(xml, 'LastName');
      const phone = extractTag(xml, 'Phone');

      if (!firstName) return null;

      return `<h3>üë§ Client Profile</h3>
        <ul>
          <li><strong>Name:</strong> ${firstName} ${lastName}</li>
          <li><strong>Phone:</strong> ${phone || 'N/A'}</li>
        </ul>`;
    }

    function interpretLocations(xml) {
      const locationRegex = /<Location>([\s\S]*?)<\/Location>/g;
      let match;
      let count = 0;

      while ((match = locationRegex.exec(xml)) !== null) {
        count++;
      }

      if (count === 0) return null;

      return `<h3>üìç Saved Locations</h3>
        <p>Found <strong>${count}</strong> saved location(s) (registered addresses + frequent destinations)</p>`;
    }

    function interpretFrequentTrips(xml) {
      const tripRegex = /<FrequentTrip>([\s\S]*?)<\/FrequentTrip>/g;
      let match;
      let count = 0;

      while ((match = tripRegex.exec(xml)) !== null) {
        count++;
      }

      if (count === 0) return null;

      return `<h3>üîÑ Frequent Trips</h3>
        <p>Found <strong>${count}</strong> frequently used trip pair(s)</p>`;
    }

    function extractTag(xml, tagName) {
      const regex = new RegExp(`<${tagName}>(.*?)</${tagName}>`, 'i');
      const match = xml.match(regex);
      return match ? match[1] : null;
    }

    function copyResponse() {
      const xml = document.getElementById('responseXml').textContent;
      navigator.clipboard.writeText(xml).then(() => {
        const btn = event.target;
        btn.textContent = 'Copied ‚úì';
        setTimeout(() => {
          btn.textContent = 'Copy XML';
        }, 2000);
      });
    }

    function clearResponse() {
      document.getElementById('responsePanel').style.display = 'none';
    }

    // Initialize
    updateOperationParams();
  </script>
</body>
</html>
